{% extends 'base.html' %}
{% block title %}{% if get_locale() == 'ar' %}التذاكر{% else %}Tickets{% endif %}{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>{% if get_locale() == 'ar' %}التذاكر{% else %}Tickets{% endif %}</h2>
    <!-- منطقة ملخص الأرباح والخسائر -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div style="background-color: #198754; color: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 2px 6px #0001;">
                <strong>{% if get_locale() == 'ar' %}مجموع الأرباح:{% else %}Total Profits:{% endif %}</strong>
                {{ format_currency(tickets|map(attribute='profit')|select('gt', 0)|sum, base_currency.id) }}
            </div>
        </div>
        <div class="col-md-6">
            <div style="background-color: #dc3545; color: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 2px 6px #0001;">
                <strong>{% if get_locale() == 'ar' %}مجموع الخسائر:{% else %}Total Losses:{% endif %}</strong>
                {{ format_currency(tickets|map(attribute='profit')|select('lt', 0)|sum, base_currency.id) }}
            </div>
        </div>
    </div>
    <form method="POST" action="/tickets" class="p-4 bg-light rounded shadow-sm mb-4">
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="ticketNumber" class="form-label">{% if get_locale() == 'ar' %}رقم التذكرة{% else %}Ticket Number{% endif %}</label>
            <input type="text" id="ticketNumber" name="ticket_number" class="form-control" placeholder="{% if get_locale() == 'ar' %}رقم التذكرة{% else %}Ticket Number{% endif %}" required>
        </div>
        <div class="col-md-2">
            <label for="pnr" class="form-label">PNR</label>
            <input type="text" id="pnr" name="pnr" class="form-control" placeholder="PNR" required>
        </div>
        <div class="col-md-3">
            <label for="departureLocation" class="form-label">{% if get_locale() == 'ar' %}مكان المغادرة{% else %}Departure{% endif %}</label>
            <input type="text" id="departureLocation" name="departure_location" class="form-control" placeholder="{% if get_locale() == 'ar' %}مكان المغادرة{% else %}Departure{% endif %}" required>
        </div>
        <div class="col-md-3">
            <label for="arrivalLocation" class="form-label">{% if get_locale() == 'ar' %}مكان الوصول{% else %}Arrival{% endif %}</label>
            <input type="text" id="arrivalLocation" name="arrival_location" class="form-control" placeholder="{% if get_locale() == 'ar' %}مكان الوصول{% else %}Arrival{% endif %}" required>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <label for="customerName" class="form-label">{% if get_locale() == 'ar' %}اسم العميل{% else %}Customer Name{% endif %}</label>
            <input type="text" id="customerName" name="customer_name" class="form-control" placeholder="{% if get_locale() == 'ar' %}اسم العميل{% else %}Customer Name{% endif %}">
        </div>
        <div class="col-md-4">
            <label for="ticketSource" class="form-label">{% if get_locale() == 'ar' %}مصدر التذكرة{% else %}Ticket Source{% endif %}</label>
            <input type="text" id="ticketSource" name="ticket_source" class="form-control" placeholder="{% if get_locale() == 'ar' %}مصدر التذكرة{% else %}Ticket Source{% endif %}">
        </div>
        <div class="col-md-2">
            <label for="passengersCount" class="form-label">{% if get_locale() == 'ar' %}عدد الأفراد{% else %}Passengers{% endif %}</label>
            <input type="number" id="passengersCount" name="passengers_count" class="form-control" min="1" value="1">
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <label for="purchasePrice" class="form-label">{% if get_locale() == 'ar' %}سعر الشراء{% else %}Purchase Price{% endif %}</label>
            <input type="number" step="0.01" id="purchasePrice" name="purchase_price" class="form-control" placeholder="{% if get_locale() == 'ar' %}سعر الشراء{% else %}Purchase Price{% endif %}" required>
        </div>
        <div class="col-md-3">
            <label for="sellingPrice" class="form-label">{% if get_locale() == 'ar' %}سعر البيع{% else %}Selling Price{% endif %}</label>
            <input type="number" step="0.01" id="sellingPrice" name="selling_price" class="form-control" placeholder="{% if get_locale() == 'ar' %}سعر البيع{% else %}Selling Price{% endif %}" required>
        </div>
        <div class="col-md-3">
            <label for="ticketCurrency" class="form-label">{% if get_locale() == 'ar' %}العملة{% else %}Currency{% endif %}</label>
            <select id="ticketCurrency" name="currency_id" class="form-select" required>
                {% for currency in currencies %}
                    <option value="{{ currency.id }}">{{ currency.code }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="paymentFees" class="form-label">{% if get_locale() == 'ar' %}رسوم الدفع{% else %}Payment Fees{% endif %}</label>
            <input type="number" step="0.01" id="paymentFees" name="payment_fees" class="form-control" placeholder="{% if get_locale() == 'ar' %}رسوم الدفع{% else %}Payment Fees{% endif %}" value="0">
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="paymentMethod" class="form-label">{% if get_locale() == 'ar' %}طريقة الدفع{% else %}Payment Method{% endif %}</label>
            <input type="text" id="paymentMethod" name="payment_method" class="form-control" placeholder="{% if get_locale() == 'ar' %}طريقة الدفع{% else %}Payment Method{% endif %}">
        </div>
        <div class="col-md-8">
            <label for="notes" class="form-label">{% if get_locale() == 'ar' %}ملاحظات{% else %}Notes{% endif %}</label>
            <input type="text" id="notes" name="notes" class="form-control" placeholder="{% if get_locale() == 'ar' %}ملاحظات{% else %}Notes{% endif %}">
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 text-end">
            <button type="submit" class="btn btn-primary px-5">{% if get_locale() == 'ar' %}إضافة جديد{% else %}Add New{% endif %}</button>
        </div>
    </div>
</form>
    <hr>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>{% if get_locale() == 'ar' %}رقم التذكرة{% else %}Ticket Number{% endif %}</th>
                <th>PNR</th>
                <th>{% if get_locale() == 'ar' %}مكان المغادرة{% else %}Departure{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}مكان الوصول{% else %}Arrival{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}اسم العميل{% else %}Customer Name{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}مصدر التذكرة{% else %}Ticket Source{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}عدد الأفراد{% else %}Passengers{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}سعر الشراء{% else %}Purchase Price{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}سعر البيع{% else %}Selling Price{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}رسوم الدفع{% else %}Payment Fees{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}الربح{% else %}Profit{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}العملة{% else %}Currency{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}طريقة الدفع{% else %}Payment Method{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}ملاحظات{% else %}Notes{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}الإجراءات{% else %}Actions{% endif %}</th>
            </tr>
        </thead>
        <tbody>
            {% set currency_code = base_currency.code.lower() %}
            {% for ticket in tickets %}
            <tr>
                <td>{{ ticket.id }}</td>
                <td>{{ ticket.ticket_number }}</td>
                <td>{{ ticket.pnr }}</td>
                <td>{{ ticket.departure_location }}</td>
                <td>{{ ticket.arrival_location }}</td>
                <td>{{ ticket.customer_name }}</td>
                <td>{{ ticket.ticket_source }}</td>
                <td>{{ ticket.passengers_count }}</td>
                <td>
                  {{ format_currency(attribute(ticket, 'purchase_price_' ~ currency_code), base_currency.id) }}
                </td>
                <td>
                  {{ format_currency(attribute(ticket, 'selling_price_' ~ currency_code), base_currency.id) }}
                </td>
                <td>
                  {{ format_currency(attribute(ticket, 'payment_fees_' ~ currency_code), base_currency.id) }}
                </td>
                <td>
                  {{ format_currency(attribute(ticket, 'profit_' ~ currency_code), base_currency.id) }}
                </td>
                <td>{{ base_currency.code }}</td>
                <td>{{ ticket.payment_method }}</td>
                <td>{{ ticket.notes }}</td>
                <td>
                    <form method="POST" action="/tickets/delete/{{ ticket.id }}" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm">{% if get_locale() == 'ar' %}حذف{% else %}Delete{% endif %}</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
