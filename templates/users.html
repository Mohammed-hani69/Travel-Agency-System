{% extends 'base.html' %}
{% block title %}{% if get_locale() == 'ar' %}إدارة المستخدمين{% else %}User Management{% endif %}{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>{% if get_locale() == 'ar' %}إدارة المستخدمين{% else %}User Management{% endif %}</h2>
    <form method="POST" action="/users" class="p-3 bg-light rounded shadow-sm mb-4">
        <input type="hidden" name="user_id" value="{{ edit_user.id if edit_user else '' }}">
        <div class="row mb-3">
            <div class="col-md-4 mb-2">
                <label for="userEmail" class="form-label">{% if get_locale() == 'ar' %}البريد الإلكتروني{% else %}Email{% endif %}</label>
                <input type="email" id="userEmail" name="email" class="form-control" required value="{{ edit_user.email if edit_user else '' }}">
            </div>
            <div class="col-md-4 mb-2">
                <label for="userPassword" class="form-label">{% if get_locale() == 'ar' %}كلمة المرور{% else %}Password{% endif %}</label>
                <input type="password" id="userPassword" name="password" class="form-control" {% if not edit_user %}required{% endif %}>
            </div>
            <div class="col-md-4 mb-2">
                <label for="userRole" class="form-label">{% if get_locale() == 'ar' %}الصلاحية{% else %}Role{% endif %}</label>
                <select id="userRole" name="role" class="form-select" required onchange="togglePermissions(this.value)">
                    <option value="admin" {% if edit_user and edit_user.role == 'admin' %}selected{% endif %}>{% if get_locale() == 'ar' %}مدير عام{% else %}Admin{% endif %}</option>
                    <option value="accountant" {% if edit_user and edit_user.role == 'accountant' %}selected{% endif %}>{% if get_locale() == 'ar' %}محاسب{% else %}Accountant{% endif %}</option>
                    <option value="employee" {% if edit_user and edit_user.role == 'employee' %}selected{% endif %}>{% if get_locale() == 'ar' %}موظف{% else %}Employee{% endif %}</option>
                </select>
            </div>
        </div>
        <div class="row mb-3" id="permissionsRow">
            <div class="col-md-12 mb-2">
                <label class="form-label">{% if get_locale() == 'ar' %}صلاحيات الوصول للصفحات{% else %}Page Permissions{% endif %}</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="dashboard" id="permDashboard" {% if edit_user and 'dashboard' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permDashboard">{% if get_locale() == 'ar' %}لوحة التحكم{% else %}Dashboard{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="expenses" id="permExpenses" {% if edit_user and 'expenses' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permExpenses">{% if get_locale() == 'ar' %}المصروفات{% else %}Expenses{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="salaries" id="permSalaries" {% if edit_user and 'salaries' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permSalaries">{% if get_locale() == 'ar' %}الرواتب{% else %}Salaries{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="tickets" id="permTickets" {% if edit_user and 'tickets' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permTickets">{% if get_locale() == 'ar' %}التذاكر{% else %}Tickets{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="hotels" id="permHotels" {% if edit_user and 'hotels' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permHotels">{% if get_locale() == 'ar' %}الفنادق{% else %}Hotels{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="currencies" id="permCurrencies" {% if edit_user and 'currencies' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permCurrencies">{% if get_locale() == 'ar' %}إعدادات العملة{% else %}Currency Settings{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="export" id="permExport" {% if edit_user and 'export' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permExport">{% if get_locale() == 'ar' %}تصدير البيانات{% else %}Export Data{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="users" id="permUsers" {% if edit_user and 'users' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permUsers">{% if get_locale() == 'ar' %}المستخدمين{% else %}Users{% endif %}</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="permissions" value="visas" id="permVisas" {% if edit_user and 'visas' in edit_user.permissions %}checked{% endif %}>
                    <label class="form-check-label" for="permVisas">{% if get_locale() == 'ar' %}التأشيرات{% else %}Visas{% endif %}</label>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 text-end">
                <button type="submit" class="btn btn-primary px-4">{% if edit_user %}{% if get_locale() == 'ar' %}تحديث المستخدم{% else %}Update User{% endif %}{% else %}{% if get_locale() == 'ar' %}إضافة مستخدم{% else %}Add User{% endif %}{% endif %}</button>
            </div>
        </div>
    </form>
    <script>
    function togglePermissions(role) {
        var permRow = document.getElementById('permissionsRow');
        if(role === 'admin') {
            permRow.style.display = 'none';
        } else {
            permRow.style.display = 'block';
        }
    }
    // عند تحميل الصفحة، إخفاء الصلاحيات إذا كان المدير عام
    document.addEventListener('DOMContentLoaded', function() {
        var role = document.getElementById('userRole').value;
        togglePermissions(role);
    });
    function editUser(userId) {
        // إعادة تحميل الصفحة مع user_id في الكويري سترينج
        window.location.href = '/users?edit_id=' + userId;
    }
    </script>
    <hr>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>{% if get_locale() == 'ar' %}البريد الإلكتروني{% else %}Email{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}الصلاحية{% else %}Role{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}صلاحيات الوصول{% else %}Permissions{% endif %}</th>
                <th>{% if get_locale() == 'ar' %}الإجراءات{% else %}Actions{% endif %}</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            {% if user.email != 'ezezo291@gmail.com' %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.email }}</td>
                <td>{% if user.role == 'admin' %}{% if get_locale() == 'ar' %}مدير عام{% else %}Admin{% endif %}{% elif user.role == 'accountant' %}{% if get_locale() == 'ar' %}محاسب{% else %}Accountant{% endif %}{% else %}{% if get_locale() == 'ar' %}موظف{% else %}Employee{% endif %}{% endif %}</td>
                <td>{{ user.permissions|join(', ') }}</td>
                <td>
                    <form method="POST" action="/users/toggle_active" style="display:inline;">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        {% if user.is_active %}
                        <button type="submit" class="btn btn-warning btn-sm">{% if get_locale() == 'ar' %}إيقاف{% else %}Deactivate{% endif %}</button>
                        {% else %}
                        <button type="submit" class="btn btn-success btn-sm">{% if get_locale() == 'ar' %}تفعيل{% else %}Activate{% endif %}</button>
                        {% endif %}
                    </form>
                    <form method="POST" action="/users/delete" style="display:inline;" onsubmit="return confirm('{% if get_locale() == 'ar' %}هل أنت متأكد من حذف المستخدم؟{% else %}Are you sure you want to delete this user?{% endif %}');">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <button type="submit" class="btn btn-danger btn-sm">{% if get_locale() == 'ar' %}حذف{% else %}Delete{% endif %}</button>
                    </form>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
